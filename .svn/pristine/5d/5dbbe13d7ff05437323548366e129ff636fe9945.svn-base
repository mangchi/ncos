<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="~{th/cmmn/layout}">
<head>
<title>보고서 스케쥴 관리</title>
</head>
<th:block layout:fragment="content">
<div class="container-wide">
	<div class="container">
		<div class="grid-row">
			<div class="item-box col-12">
				<div class="inner">
					<h4 class="item-title"><span class="iconWrapB icon_04_01"></span><strong>보고서 스케줄 관리</strong></h4>
				</div>
			</div>
		</div>
		<div class="grid-row">
			<div class="item-box col-12">
				<div class="inner" style="overflow: visible"> 
					<h4 class="item-title"><span class="iconWrapB icon_search"></span><strong>조회조건</strong></h4>
					<div class="items" style="overflow: visible">
						<!-- item contnets // -->
						<div class="schwrap">
							<ul>
								<li>
									<label>스케줄명
										<input type="text" id="schScheduleNm" class="form-control korEng" placeholder="스케줄명을 입력하세요">
									</label>
								</li>
								<li>
									<label>보고서명
										<input type="text" id="schReportTitle" class="form-control korEng" placeholder="보고서명을 입력하세요">
									</label>
								</li>
								<li>
								    <div class="selectWrap">사용여부
										<div class="select">
											<div class="selected">
												<div data-value='' class="selected-value">전체</div>
												<div class="arrow"></div>
											</div>
											<ul id="schUseFlag">
											</ul>
										</div>
									</div>
								</li>
								<li>
									<div class="selectWrap">등록자
										<div class="multiselect">
											<div class="selectBox">
												<div class="selected">
													<div class="selected-value">전체</div>
													<div class="arrow"></div>
												</div>
												<div class="overSelect"></div>
											</div>
											<div id="schAccountId" class="checkboxes" style="display:none;">
											</div>
										</div>
									</div>
								</li>
							</ul>
							<button class="btn medium darkblue schBtn"><span class="iconBtn icon_btn_01"></span><strong>검색</strong></button>
						</div>
						<!-- // item contnets --> 
					</div>
				</div>
			</div>
		</div>
		<div class="grid-row">
			<div class="item-box col-12">
				<div class="inner">
					<h4 class="item-title"><span class="iconWrapB icon_list"></span><strong>조회목록</strong></h4>
					<div class="items"> 
						<!--table//-->
						<div class="tablewrap">
							<table>
								<thead class="tHead">
								</thead>
								<tbody class="tBody">	
								</tbody>
							</table>
						</div>
						<!--//table--> 
						<!--pagination//-->
						<div class="page_wrap">
							<div class="page_nation"> </div>
						</div>
						<!--//pagination--> 
						<!--button area//-->
						<div class="btnWrap">
							<div class="left"> <a href="#reportSchReg" class="btn medium darkblue addBtn"><span class="iconBtn icon_btn_02"></span><strong>추가</strong></a> <a href="#reportSchReg" class="btn medium darkblue modBtn"><span class="iconBtn icon_btn_03"></span><strong>수정</strong></a> <a href="#stop" class="btn medium darkblue delBtn"><span class="iconBtn icon_btn_04"></span><strong>삭제</strong></a> </div>
							<div class="right"> </div>
						</div>
						<!--//button area--> 
					</div>
				</div>
			</div>
		</div>
		<!--//Grid--> 
	</div>
</div>
<!--보고서 스케줄등록 modal popup//-->
<div class="dim-layer">
	<div class="dimBg"></div>
	<div id="reportSchReg" class="pop-layer ssmall" style="width:340px;"> 
		<!--Title-->
		<div class="Popup-title">
			<h3><span class="iconWrapB icon_04_01"></span><strong>보고서 스케줄등록</strong></h3>
			<button class="icon-close">닫기</button>
		</div>
		<div class="Popup-container"> 
			<!--Contens-->
			<div class="Popup-contents">
				<div class="assetWrap">
					<ul>
						<li>
							<label>
								<span>스케줄명</span>
								<input id="scheduleTitle" style="width:200px;" type="text" class="form-control korEng" placeholder="스케줄명">
								<input id="scheduleId" type="hidden">
							</label>
						</li>
						<li>
						    <label>
								<span>보고서서식</span>
								<input id="reportTitle" style="width:200px;" type="text" class="form-control korEng" placeholder="보고서명" readonly>
								<input id="formId" type="hidden">
							</label>
						</li>
						<li>
							<label>
								<span>생성 시간</span>
								<input id="createTime" style="width:200px;" type="datetime-local" data-placeholder="날짜 선택" value="" class="form-control" ></input>
							</label>
						</li>
						<li>
						    <div class="selectWrap">생성 주기
								<div class="select" style="width:200px;">
									<div class="selected">
										<div data-value=''  class="selected-value">선택</div>
										<div class="arrow"></div>
									</div>
									<ul id="periodId" style="width:200px;height:100px;overflow:auto;">
									</ul>
								</div>
							</div>
						</li>
						<li>
							<label>
								<span>&nbsp;</span>
								<div><input id="useFlag" type="checkbox" > 사용여부</div>
							</label>
						</li>
					</ul>
				</div>
			</div>
		</div>
		<div class="Popup-footer">
			<a href="javascript:;" class="btn medium darkblue saveBtn"><span class="iconBtn icon_btn_09"></span><strong>확인</strong></a>
			<a href="javascript:;" class="btn medium darkblue popClose"><span class="iconBtn icon_btn_08"></span><strong>취소</strong></a>
		</div>
	</div>
</div>
<!--//modal popup--> 
<div class="dim-layer">
	<div class="dimBg"></div>
	<div id="reportFormList" class="pop-layer small" style="height:500px;"> 
		<!--Title-->
		<div class="Popup-title">
			<h3><strong>레포트 서식 리스트</strong></h3>
			<button class="icon-close">닫기</button>
		</div>
		<div class="Popup-container"> 
			<!--Contens-->
			<div class="Popup-contents">
				<div class="tablewrap" style="height:500px; overflow:auto;">
					<table >
						<thead class="tHead">
						</thead>
						<tbody class="tBody" >
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>
</div>
<script th:inline="javascript" > 
	window.addEventListener('DOMContentLoaded', () => {
		init();
	});
   
    const init = () => {
    	//gfn_codes().then(() => {
    		createMultiChk(document.getElementById('schAccountId'),'UA');
    		createChk(document.getElementById('schUseFlag'),'COUSE','전체');
        	const headColumns = [{data_id:"id",width: "0px"}
        	                    ,{data_id:"chk", width: "45px"}
        	                    ,{data_id:"rn",label: "No."}
    					        ,{data_id:"scheduleTitle",label:"스케쥴명" }
    					        ,{data_id:"formId",width:"0px"}
    					        ,{data_id:"reportTitle",label:"보고서명"}
    					        ,{data_id:"periodId",label:"보고서 생성주기",data_grpCd:"RECY"}
    					        ,{data_id:"createTime",label:"보고서 생성 기준시간",data_dateFrmt:"yy-mm-dd hh:mi:ss"}
    					        ,{data_id:"username",label:"보고서 등록자"}
    					        ,{data_id:"useFlag",label:"사용여부" , data_grpCd:"COUSE"}    					       
    					        ];
            gridInit(document.querySelector('.container-wide').querySelector('.tablewrap'),headColumns);
    		pageInit(document.querySelector(".page_nation"),searchFunc,page.rowPerPage);
    		searchFunc();
    		const modalHeadColumns = [{data_id:"id",label:"",width:"0px"}
							    	 ,{data_id:"rn",label: "No."}
							         ,{data_id:"reportTitle",label: "보고서 제목"}
							         ,{data_id:"reportType",label:"보고서 유형", data_grpCd:"RETY"}
							         ,{data_id:"detailBtn",label:"선택",data_btnNm:"선택" }
							         ];
            gridInit(document.querySelector('#reportFormList').querySelector('.tablewrap'),modalHeadColumns);
    	//});
    }
    
    const searchFunc = (invoker) => {
    	pageSearch("/getRptSchlList",document.querySelector(".tablewrap"),document.querySelector(".page_nation"),invoker,searchFunc);
    }
    
    
    document.querySelector('.schBtn').addEventListener('click',(e) => {
    	e.preventDefault();
    	searchFunc();
    });
    
    document.querySelector('.modBtn').addEventListener('click',(e) => {
    	e.preventDefault();
    	let modData = gridClickedData(document.querySelector('.container-wide').querySelector('.tablewrap'));
    	let obj = new Object();
    	let isEmpty = Object.entries(modData.row).length === 0;
    	if(!isEmpty){
    		setLayerData(e.target,modData.row);
    		//gfn_asyncJsonCall('/modAsset','POST',modData,null,trncAfterFunc);
    		let href = null;
    		if(e.target.tagName === 'STRONG'){
    			href = e.target.parentElement.getAttribute('href');
    		}
    		else if(e.target.tagName === 'SPAN'){
    			href = e.target.parentElement.getAttribute('href');
    		}
    		else{
    			href = e.target.getAttribute('href');
    		}
    		layerPopup(href);
    	}

    });
    
    document.querySelector('.delBtn').addEventListener('click',(e) => {
    	e.preventDefault();
    	let delData = gridCheckedData(document.querySelector('.container-wide').querySelector('.tablewrap'));
    	console.log("delData:",delData)
    	if(delData.list.length > 0){;
    		gfn_asyncTranDataCall('/deleteRptSch','POST',delData,trncRptSchAfterFunc,true);
    	}
    });
    
    const setLayerData = (target,data) => {
    	gfn_initObj(document.getElementById('reportSchReg'));
    	document.getElementById('createTime').value = '';
    	createChk(document.getElementById('periodId'),'RECY');
    	document.getElementById('useFlag').checked = true;
    	if(target.parentNode.classList.contains('modBtn') || target.classList.contains('modBtn')){
    		let periodId = document.getElementById('periodId');
    		console.log("data:",data);
    		document.getElementById('scheduleId').value = data.id;
    		document.getElementById('scheduleTitle').value = data.scheduleTitle;
    		document.getElementById('reportTitle').value = data.reportTitle;
    		document.getElementById('createTime').value = data.createTime;
    		document.getElementById('formId').value = data.formId;
    		setCheckValue(periodId.querySelectorAll('li'),periodId.parentNode.querySelector('.selected-value'),data.periodId);
        	
    		if(data.useFlag != '1'){
    			document.getElementById('useFlag').checked = false;
    		}
    	}
    }
    
    document.getElementById('reportSchReg').querySelector('.saveBtn').addEventListener('click',(e) => {
    	e.preventDefault();
    	if(gfn_validDay(new Date().toISOString(),document.getElementById('createTime').value) && document.getElementById('useFlag').checked){
	    	msgCall(msg.invalidTm,false,false,() => {
				document.getElementById('createTime').focus();
			});
    	}
    	else{
    		let requiredParams = {scheduleTitle: "스케쥴명"
				             ,reportTitle: "보고서"
				             ,createTime: "생성 시간"
				             ,periodId: "생성 주기"};
			gfn_asyncTranCall('/saveRptSch','POST',requiredParams,document.getElementById('reportSchReg'),trncRptSchAfterFunc,true);
    	}
    	
    });
    
    const trncRptSchAfterFunc = () => {
    	document.getElementById('reportSchReg').querySelector('.popClose').click();
    	searchFunc();
    }
    
    document.getElementById('reportTitle').addEventListener('click',(e) => {
    	e.preventDefault();
	 	gfn_asyncJsonCall('/getRptFrms','GET').then((data) => {
	 		let list = data['list'];
	 		gridBind(list,document.querySelector('#reportFormList').querySelector('.tablewrap'));
	 	}).then(() => {
	 		layerPopup('#reportFormList');
	 	}); 

    });
    
    const detailFunc = (data) => {
    	console.log("data::::",data)
    	document.getElementById('reportFormList').querySelector('.icon-close').click();
    	document.getElementById('formId').value = data.id;
    	document.getElementById('reportTitle').value = data.reportTitle;
    	
    };

</script>
</th:block>
</html>
