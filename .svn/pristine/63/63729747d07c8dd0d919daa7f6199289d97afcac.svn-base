<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="~{th/cmmn/layout}">
<head>
<title>사용자 관리</title>
</head>
<th:block layout:fragment="content">
<div class="container-wide">
	<div class="container">
		<div class="grid-row">
			<div class="item-box col-12">
				<div class="inner">
					<h4 class="item-title"><span class="iconWrapB icon_03_01"></span><strong>사용자 관리</strong></h4>
				</div>
			</div>
		</div>
		<div class="grid-row">
			<div class="item-box col-12">
				<div class="inner">
					<h4 class="item-title"><span class="iconWrapB icon_search"></span><strong>조회조건</strong></h4>
					<div class="items" style="overflow: visible"> 
						<!-- item contnets // -->
						<div class="schwrap">
							<ul>
								<li>
									<div class="selectWrap">소속
										<div class="multiselect">
											<div class="selectBox">
												<div class="selected">
													<div class="selected-value">전체</div>
													<div class="arrow"></div>
												</div>
												<div class="overSelect"></div>
											</div>
											<div id="schAffiliationId" class="checkboxes" style="display:none;">
											</div>
										</div>
									</div>
								</li>
								<li>
									<div class="selectWrap">사용자
										<div class="multiselect">
											<div class="selectBox">
												<div class="selected">
													<div class="selected-value">전체</div>
													<div class="arrow"></div>
												</div>
												<div class="overSelect"></div>
											</div>
											<div id="schAccountId" class="checkboxes" style="display:none;">
											</div>
										</div>
									</div>
								</li>
							</ul>
							<button class="btn medium darkblue schBtn"><span class="iconBtn icon_btn_01"></span><strong>검색</strong></button>
						</div>
						<!-- // item contnets --> 
					</div>
				</div>
			</div>
		</div>
		<div class="grid-row">
			<div class="item-box col-12">
				<div class="inner">
					<h4 class="item-title"><span class="iconWrapB icon_list"></span><strong>조회목록</strong></h4>
					<div class="items"> 
						<div class="tablewrap">
							<table>
								<thead class="tHead">
								</thead>
								<tbody class="tBody">	
								</tbody>
							</table>
						</div>
						<div class="page_wrap">
							<div class="page_nation">
								<input type="hidden" name="rowPerPage" class="rowPerPage" value="10">
							</div>
                        </div>
						<div class="btnWrap">
							<div class="left"> 
							<a href="#userReg" class="btn medium darkblue addBtn"><span class="iconBtn icon_btn_02"></span><strong>추가</strong></a> 
							<a href="#userReg" class="btn medium darkblue modBtn"><span class="iconBtn icon_btn_03"></span><strong>수정</strong></a> 
							<a href="javascript:;" class="btn medium darkblue delBtn"><span class="iconBtn icon_btn_04"></span><strong>삭제</strong></a> 
							<a href="javascript:;" class="btn medium darkblue pwdInitBtn"><span class="iconBtn icon_btn_08"></span><strong>비밀번호 초기화</strong></a> 
							</div>
							<div class="right"> </div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!--//Grid--> 
	</div>
</div>

<!--//modal popup--> 
<script th:inline="javascript"> 
	window.addEventListener('DOMContentLoaded', () => {
		init();

	});
    const init = () => {
    	createMultiChk(document.getElementById('schAffiliationId'),'COUT');
    	gfn_getCodeUser().then((data) => {
    		createMultiChk(document.getElementById('schAccountId'),'UA', data.info);
    		gfn_showChkVal(document.getElementById('schAccountId'));
    	});
    	const headColumns = [{data_id:"id",width: "0px"}
    	                    ,{data_id:"chk", width: "45px"}
					    	,{data_id:"rn",label: "No."}
					        ,{data_id:"userId",label: "사용자 아이디"}
					        ,{data_id:"username",label:"사용자명"}
					        ,{data_id:"classId",label:"직위",data_grpCd:"URGR"}
					        ,{data_id:"affiliationId",label:"소속", data_grpCd:"COUT"}
					        ,{data_id:"authorization",label:"권한", data_grpCd:"URAU"}
					        ,{data_id:"phoneNo",label:"연락처"}
                            ,{data_id:"accountActivation",label:"계정 상태",data_grpCd:"ACAT"}

					        ];
        gridInit(document.querySelector('.tablewrap'),headColumns);
		pageInit(document.querySelector(".page_nation"),searchFunc,page.rowPerPage);
		searchFunc();
    }
    
    const searchFunc = (invoker) => {
    	pageSearch("/userAccountList",document.querySelector(".tablewrap"),document.querySelector(".page_nation"),invoker,searchFunc);
    }
    
    
    document.querySelector('.schBtn').addEventListener('click',(e) => {
    	e.preventDefault();
    	searchFunc(e.target);
    });
    
    document.querySelector('.addBtn').addEventListener('click',(e) => {
		let sessionTime = gfn_getStorageItem('sessionTm',false);
		if(gfn_nullValue(sessionTime) != '' && sessionTime > -1){
			clearInterval(loginInterval);
			setTimer(sessionTime);
		}
    	document.querySelector('#userReg').querySelector('.Popup-title').querySelector('strong').textContent = '사용자 등록';
    	document.querySelectorAll('.password').forEach(password => {
    		if(password.style.display === 'none')password.style.display = '';
		});
    	document.querySelector('#userReg').querySelector('.accountActivation').style.display = '';
    });
    
    document.querySelector('.modBtn').addEventListener('click',(e) => {
    	e.preventDefault();
    	let modData = gridClickedData(document.querySelector('.tablewrap'));
    	document.querySelector('#userReg').querySelector('.Popup-title').querySelector('strong').textContent = '사용자 수정';
    	document.querySelectorAll('.password').forEach(password => {
    			password.style.display = 'none';
    	});
    	document.querySelector('#userReg').querySelector('.accountActivation').style.display = '';
    	let obj = new Object();
    	let isEmpty = Object.entries(modData.row).length === 0;
    	if(!isEmpty){
    		setLayerData(e.target,modData.row);
    		let href = null;
    		if(e.target.tagName === 'STRONG'){
    			href = e.target.parentElement.getAttribute('href');
    		}
    		else if(e.target.tagName === 'SPAN'){
    			href = e.target.parentElement.getAttribute('href');
    		}
    		else{
    			href = e.target.getAttribute('href');
    		}
    		layerPopup(href);
    	}
    	
    });
    
    const setLayerData = (target,data)=> {
    	console.log("data:",data);
    	gfn_initObj(document.getElementById('userReg'));
    	createChk(document.getElementById('classId'),'URGR');
    	createChk(document.getElementById('affiliationId'),'COUT');
		createChk(document.getElementById('authorization'),'URAU');
		createChk(document.getElementById('accountActivation'),'ACAT');
    	if(target.parentNode.classList.contains('modBtn') || target.classList.contains('modBtn')){
    		document.getElementById('accountId').value = data.id;
    	    let classId = document.getElementById('classId');
    		let affiliationId = document.getElementById('affiliationId');
    		let authorization = document.getElementById('authorization');
    		let accountActivation = document.getElementById('accountActivation');
    		document.getElementById('accountId').value = data.id;
    		setCheckValue(classId.querySelectorAll('li'),classId.parentNode.querySelector('.selected-value'),data.classId);
    		setCheckValue(affiliationId.querySelectorAll('li'),affiliationId.parentNode.querySelector('.selected-value'),data.affiliationId);
    		setCheckValue(authorization.querySelectorAll('li'),authorization.parentNode.querySelector('.selected-value'),data.authorization);
    		setCheckValue(accountActivation.querySelectorAll('li'),accountActivation.parentNode.querySelector('.selected-value'),data.accountActivation=="true" ? 1 : 0);
    		let inputs = document.getElementById('userReg').getElementsByTagName('input');
    		for (let input of inputs) {
    			if(input.type === 'text'){
    				input.value = data[input.id];
    			}
    		}
    		
    	} 
    }
    
    document.querySelector('.delBtn').addEventListener('click',(e) => {
    	e.preventDefault();
    	let chkData = gridCheckedData(document.querySelector('.tablewrap'));
    	if(chkData.list.length > 0){
    		gfn_asyncTranDataCall('/delUserAccount','POST',chkData,trncUserAfterFunc,true);
    	}
    });
    
    document.querySelector('.pwdInitBtn').addEventListener('click',(e) => {
    	e.preventDefault();
    	let chkData = gridCheckedData(document.querySelector('.tablewrap'));
    	if(chkData.list.length > 0){
    		gfn_asyncTranDataCall('/pwdInit','POST',chkData,trncUserAfterFunc,true);
    	}
    });


   
</script>
</th:block>

</html>
