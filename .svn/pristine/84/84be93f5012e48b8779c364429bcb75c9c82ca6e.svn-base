<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="Threat">
  
  <select id="selectThreatCount" parameterType="map" resultType="long">
        SELECT COUNT(1) 
          FROM threat_info A
          LEFT JOIN threat_analysis B
          ON A.THREAT_ID = B.THREAT_ID
        <include refid="whereThreatList"></include>
  </select>

  <select id="selectThreatList" parameterType="map" resultType="CmmnMap">

     	SELECT  RN
     	      , B.THREAT_ID ID
              , DETECTION_TIME
     	      , UNIT_ID
     	      , SHIP_ID
     	      , SRC_IP
     	      , DST_IP
     	      , SRC_PORT
     	      , DST_PORT
     	      , ANALYSIS_ID
     	      , ANALYSIS_RESULT
     	      , DETECTION_THREAT_NAME
     	      , THREAT_DETECTION_METHOD
     	      , THREAT_IMPORTANCE
        FROM ( SELECT A.THREAT_ID
                    , B.ANALYSIS_ID
                    , B.ANALYSIS_RESULT
                    , ROW_NUMBER() OVER (ORDER BY A.DETECTION_TIME DESC, A.THREAT_ID DESC) AS RN
               FROM threat_info A
               LEFT JOIN threat_analysis B
               ON A.THREAT_ID = B.THREAT_ID
               <include refid="whereThreatList"></include>
               LIMIT #{startRow},#{rowPerPage}) A
        STRAIGHT_JOIN threat_info B
        ON (A.THREAT_ID = B.THREAT_ID)
        ORDER BY RN

  </select>
  
  <sql id="whereThreatList">
         <where>
	         <choose>
	         <when test='schMode != null and schMode.equals("menual")'>
		         <if test='frDt != null and !frDt.equals("")'>
		         AND A.DETECTION_TIME <![CDATA[>=]]> #{frDt}
		         </if>
		         <if test='toDt != null and !toDt.equals("")'>
		         AND A.DETECTION_TIME <![CDATA[<=]]> #{toDt}
		         </if>
		         <if test='schSrcIp != null and !schSrcIp.equals("")'>
		         AND A.SRC_IP = #{schSrcIp}
		         </if>
		         <if test='schDstIp != null and !schDstIp.equals("")'>
		         AND A.DST_IP = #{schDstIp}
		         </if>
		         <if test='schSrcPort != null and !schSrcPort.equals("")'>
		         AND A.SRC_PORT = #{schSrcPort}
		         </if>
		         <if test='schDstPort != null and !schDstPort.equals("")'>
		         AND A.DST_PORT = #{schDstPort}
		         </if>
		         <if test='schThreatDetectionMethod != null'>
                 AND A.THREAT_DETECTION_METHOD IN 
                 <foreach collection="schThreatDetectionMethod" item="item" open="(" close=")" separator="," index="idx">
		            #{item}
			     </foreach> 
                 </if>
                 <if test='schAnalysisResult != null'>
                 AND B.ANALYSIS_RESULT IN 
                 <foreach collection="schAnalysisResult" item="item" open="(" close=")" separator="," index="idx">
		            #{item}
			     </foreach> 
                 </if>
                 <if test='schThreatImportance != null'>
                 AND A.THREAT_IMPORTANCE IN 
                 <foreach collection="schThreatImportance" item="item" open="(" close=")" separator="," index="idx">
		            #{item}
			     </foreach> 
                 </if>
	         </when>
	         <otherwise>
	         AND A.DETECTION_TIME > DATE_ADD(NOW(), INTERVAL -#{intervalHm} HOUR)
	         </otherwise>
	         </choose>
         </where>
  </sql>
  
   <select id="selectThreatCurrentList" parameterType="map" resultType="CmmnMap">

      SELECT   A.THREAT_ID ID
              , DETECTION_TIME
     	      , UNIT_ID
     	      , SHIP_ID
     	      , SRC_IP
     	      , DST_IP
     	      , SRC_PORT
     	      , DST_PORT
     	      , ANALYSIS_ID
     	      , ANALYSIS_RESULT
     	      , DETECTION_THREAT_NAME
     	      , THREAT_DETECTION_METHOD
     	      , THREAT_IMPORTANCE 
  FROM  threat_info A
   LEFT JOIN threat_analysis B
   ON A.THREAT_ID = B.THREAT_ID
   ORDER BY A.THREAT_ID DESC
   LIMIT 5

  </select>
  
   <select id="selectThreatInfo" parameterType="map" resultType="CmmnMap">
        SELECT A.THREAT_ID
              ,ANALYSIS_ID
              ,UNIT_ID
              ,SHIP_ID
              ,DETECTION_TIME
              ,SRC_IP
              ,DST_IP
              ,SRC_PORT
              ,DST_PORT
              ,PROTOCOL
              ,PAYLOAD_SIZE
              ,FRAGMENTATION
              ,FRAGMENT_ID
              ,DETECTION_THREAT_NAME
              ,THREAT_DETECTION_METHOD
              ,THREAT_IMPORTANCE
              ,PAYLOAD
              ,ANALYSIS_RESULT
              ,IFNULL(ACTION_RESULT,1) ACTION_RESULT
          FROM threat_info A
          LEFT JOIN threat_analysis B
          ON A.THREAT_ID = B.THREAT_ID
         WHERE A.THREAT_ID = #{id}

  </select>
  
  
  <select id="selectEventStatus" parameterType="map" resultType="CmmnMap">

     	SELECT 
              (SELECT COUNT(1) FROM threat_info T1
               WHERE NOT EXISTS (SELECT T2.THREAT_ID FROM threat_analysis T2 WHERE T2.THREAT_ID = T1.THREAT_ID AND T2.ACTION_RESULT = 2)
               AND  T1.THREAT_IMPORTANCE = '5'
<!--                AND T1.DETECTION_TIME > DATE_ADD(NOW(), INTERVAL -24 HOUR) -->
		      ) HIGH_PRIOR
		     ,(SELECT COUNT(1) FROM threat_info T1
               WHERE NOT EXISTS (SELECT T2.THREAT_ID FROM threat_analysis T2 WHERE T2.THREAT_ID = T1.THREAT_ID AND T2.ACTION_RESULT = 2)
               AND T1.THREAT_IMPORTANCE = '3'
<!--                AND T1.DETECTION_TIME > DATE_ADD(NOW(), INTERVAL -24 HOUR) -->
		       ) MIDDLE_PRIOR
		     ,(SELECT COUNT(1) FROM threat_info T1
               WHERE NOT EXISTS (SELECT T2.THREAT_ID FROM threat_analysis T2 WHERE T2.THREAT_ID = T1.THREAT_ID AND T2.ACTION_RESULT = 2)
               AND T1.THREAT_IMPORTANCE = '1'
<!--                AND T1.DETECTION_TIME > DATE_ADD(NOW(), INTERVAL -24 HOUR) -->
		      ) LOW_PRIOR
		      
             , (SELECT COUNT(1) FROM threat_info T1
                WHERE NOT EXISTS (SELECT T2.THREAT_ID FROM threat_analysis T2 WHERE T2.THREAT_ID = T1.THREAT_ID AND T2.ACTION_RESULT = 2)
<!--                 AND T1.DETECTION_TIME > DATE_ADD(NOW(), INTERVAL -24 HOUR) -->
               ) AS DETECT_EVENT_CNT
             , (SELECT COUNT(1) FROM threat_info T1
                WHERE NOT EXISTS (SELECT T2.THREAT_ID FROM threat_analysis T2 WHERE T2.THREAT_ID = T1.THREAT_ID AND T2.ACTION_RESULT = 2)
                AND T1.DETECTION_TIME > DATE_ADD(NOW(), INTERVAL -1 HOUR)
               )  AS UPDOWN_CNT

  </select>
  
   <select id="selectDetectPriorStatus" parameterType="map" resultType="CmmnMap">

     	SELECT TM.HM, ORD, CASE THIM WHEN  5 THEN 'H' WHEN 3 THEN 'M' ELSE 'L' END THREAT -- TI.THREAT_DETECTION_METHOD
		     , SUM(CASE WHEN TI.THREAT_IMPORTANCE IS NULL THEN 0 ELSE 1 END) CNT
		FROM 
           (SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -23 HOUR),"%H"),':00')  HM, 1 THIM, 1 ORD
			UNION
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -22 HOUR),"%H"),':00'), 1 , 2  
			UNION 
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -21 HOUR),"%H"),':00'), 1 ,3
			UNION
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -20 HOUR),"%H"),':00'), 1 ,4
			UNION 
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -19 HOUR),"%H"),':00'), 1 ,5 
			UNION
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -18 HOUR),"%H"),':00'), 1 ,6
			UNION 
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -17 HOUR),"%H"),':00'), 1 ,7  
			UNION
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -16 HOUR),"%H"),':00'), 1 ,8
			UNION 
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -15 HOUR),"%H"),':00'), 1 ,9  
			UNION
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -14 HOUR),"%H"),':00'), 1 ,10
			UNION
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -13 HOUR),"%H"),':00'), 1 ,11 
			UNION 
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -12 HOUR),"%H"),':00'), 1 ,12 
			UNION
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -11 HOUR),"%H"),':00'), 1 ,13 
			UNION 
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -10 HOUR),"%H"),':00'), 1 ,14  
			UNION
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -9 HOUR),"%H"),':00'),  1 ,15 
			UNION 
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -8 HOUR),"%H"),':00'), 1 ,16 
			UNION
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -7 HOUR),"%H"),':00'), 1 ,17 
			UNION 
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -6 HOUR),"%H"),':00'), 1 ,18 
			UNION
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -5 HOUR),"%H"),':00'), 1 ,19
			UNION 
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -4 HOUR),"%H"),':00'), 1 ,20  
			UNION
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -3 HOUR),"%H"),':00'), 1 ,21 
			UNION 
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -2 HOUR),"%H"),':00'), 1 ,22 
			UNION
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -1 HOUR),"%H"),':00'), 1 ,23
			UNION
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL 0 HOUR),"%H"),':00'), 1 ,24
			UNION
		    SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -23 HOUR),"%H"),':00') , 3 , 1 
			UNION
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -22 HOUR),"%H"),':00'), 3 , 2  
			UNION 
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -21 HOUR),"%H"),':00'), 3 ,3
			UNION
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -20 HOUR),"%H"),':00'), 3 ,4
			UNION 
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -19 HOUR),"%H"),':00'), 3 ,5 
			UNION
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -18 HOUR),"%H"),':00'), 3 ,6
			UNION 
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -17 HOUR),"%H"),':00'), 3 ,7  
			UNION
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -16 HOUR),"%H"),':00'), 3 ,8
			UNION 
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -15 HOUR),"%H"),':00'), 3 ,9  
			UNION
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -14 HOUR),"%H"),':00'), 3 ,10
			UNION
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -13 HOUR),"%H"),':00'), 3 ,11 
			UNION 
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -12 HOUR),"%H"),':00'), 3 ,12 
			UNION
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -11 HOUR),"%H"),':00'), 3 ,13 
			UNION 
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -10 HOUR),"%H"),':00'), 3 ,14  
			UNION
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -9 HOUR),"%H"),':00'), 3,15 
			UNION 
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -8 HOUR),"%H"),':00'), 3 ,16 
			UNION
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -7 HOUR),"%H"),':00'), 3 ,17 
			UNION 
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -6 HOUR),"%H"),':00'), 3 ,18 
			UNION
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -5 HOUR),"%H"),':00'), 3 ,19
			UNION 
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -4 HOUR),"%H"),':00'), 3 ,20  
			UNION
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -3 HOUR),"%H"),':00'), 3 ,21 
			UNION 
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -2 HOUR),"%H"),':00'), 3 ,22 
			UNION
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -1 HOUR),"%H"),':00'), 3 ,23
			UNION
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL 0 HOUR),"%H"),':00'),3 ,24
			UNION 
		    SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -23 HOUR),"%H"),':00') , 5, 1 
			UNION
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -22 HOUR),"%H"),':00'), 5 , 2  
			UNION 
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -21 HOUR),"%H"),':00'), 5 ,3
			UNION
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -20 HOUR),"%H"),':00'), 5 ,4
			UNION 
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -19 HOUR),"%H"),':00'), 5 ,5 
			UNION
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -18 HOUR),"%H"),':00'), 5 ,6
			UNION 
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -17 HOUR),"%H"),':00'), 5 ,7  
			UNION
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -16 HOUR),"%H"),':00'), 5 ,8
			UNION 
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -15 HOUR),"%H"),':00'), 5 ,9  
			UNION
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -14 HOUR),"%H"),':00'), 5 ,10
			UNION
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -13 HOUR),"%H"),':00'), 5 ,11 
			UNION 
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -12 HOUR),"%H"),':00'), 5 ,12 
			UNION
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -11 HOUR),"%H"),':00'), 5 ,13 
			UNION 
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -10 HOUR),"%H"),':00'), 5,14  
			UNION
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -9 HOUR),"%H"),':00'), 5, 15 
			UNION 
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -8 HOUR),"%H"),':00'), 5 ,16 
			UNION
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -7 HOUR),"%H"),':00'), 5 ,17 
			UNION 
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -6 HOUR),"%H"),':00'), 5 ,18 
			UNION
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -5 HOUR),"%H"),':00'), 5 ,19
			UNION 
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -4 HOUR),"%H"),':00'), 5 ,20  
			UNION
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -3 HOUR),"%H"),':00'), 5 ,21 
			UNION 
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -2 HOUR),"%H"),':00'), 5 ,22 
			UNION
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL -1 HOUR),"%H"),':00'), 5 ,23
			UNION
			SELECT CONCAT(DATE_FORMAT(DATE_ADD(NOW(), INTERVAL 0 HOUR),"%H"),':00'), 5,24
			) TM 
			LEFT JOIN threat_info TI
		    ON TM.HM = CONCAT(DATE_FORMAT(TI.DETECTION_TIME,"%H"),':00')
		    AND TM.THIM = TI.THREAT_IMPORTANCE
		    AND TI.DETECTION_TIME > DATE_ADD(NOW(), INTERVAL -24 HOUR)  
		    GROUP BY HM,THIM,ORD
		    ORDER BY THIM,ORD

  </select>
  
  <update id="insertThreatAnalysis" parameterType="map">
        INSERT INTO threat_analysis(THREAT_ID
                                  , ANALYST
                                  , ANALYSIS_TIME
                                  , ANALYSIS_RESULT
                                  , ACTION_RESULT
                                    )
                               VALUES(#{threatId}
                                     ,#{analyst}
                                     ,SYSDATE()
                                     ,#{analysisResult}
                                     ,#{actionResult}
                                     )
  </update>
  
   <update id="updateThreatAnalysis" parameterType="map">
        UPDATE threat_analysis
                        SET ANALYST = #{analyst}
                          , ANALYSIS_TIME = SYSDATE()
                          , ANALYSIS_RESULT = #{analysisResult}
                          , ACTION_RESULT = #{actionResult}
        WHERE ANALYSIS_ID = #{analysisId}
  </update>
  
  <update id="insertThreatAnalysisNcos" parameterType="map">
        INSERT INTO threat_analysis(THREAT_ID
                                  , ANALYST
                                  , ANALYSIS_TIME
                                  , ANALYSIS_RESULT
                                  , ACTION_RESULT
                                  , THREAT_INTEGRITY
                                    )
                               VALUES(#{threatId}
                                     ,#{analyst}
                                     ,STR_TO_DATE(#{analysisTime}, '%Y-%m-%d %H:%i.%s')
                                     ,#{analysisResult}
                                     ,#{actionResult}
                                     ,#{integrity}
                                     )
  </update>
  
   <update id="updateThreatAnalysisNcos" parameterType="map">
        UPDATE threat_analysis
                        SET ANALYST 			= #{analyst}
                          , ANALYSIS_TIME 		= STR_TO_DATE(#{analysisTime}, '%Y-%m-%d %H:%i.%s')
                          , ANALYSIS_RESULT 	= #{analysisResult}
                          , ACTION_RESULT 		= #{actionResult}
                          , THREAT_INTEGRITY 	= #{integrity}
        WHERE ANALYSIS_ID = #{analysisId}
  </update>
  
</mapper>