<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="~{th/cmmn/layout}">
<head>
<title>사이버 위협 전시</title>
</head>
<th:block layout:fragment="content">

<div class="container-wide">
	<div class="container">
		<div class="grid-row">
			<div class="item-box col-12">
				<div class="inner">
					<h4 class="item-title"><span class="iconWrapB icon_06_01"></span><strong>사이버 위협 전시</strong></h4>
				</div>
			</div>
		</div>
		<div class="grid-row">
			<div class="item-box col-3">
				<div class="inner">
					<h4 class="item-title"><span class="iconWrapB icon_06_02"></span><strong>탐지 이벤트 등급</strong></h4>
					<div class="items"> 
						<!-- item contnets // -->
						<div class="eventRating ac">
							<ul>
								<li class="high"><span>상</span><strong></strong></li>
								<li class="middle"><span>중</span><strong></strong></li>
								<li class="low"><span>하</span><strong></strong></li>
							</ul>
						</div>
						<!-- // item contnets --> 
					</div>
				</div>
			</div>
			<div class="item-box col-3">
				<div class="inner">
					<h4 class="item-title"><span class="iconWrapB icon_06_03"></span><strong>탐지 이벤트 수</strong></h4>
					<div class="items"> 
						<!-- item contnets // -->
						<div class="eventNum ac">
							<ul>
								<li class="high"><strong></strong><span></span></li>
							</ul>
						</div>
						<!-- // item contnets --> 
					</div>
				</div>
			</div>
			<div class="item-box col-7">
				<div class="inner">
					<h4 class="item-title"><span class="iconWrapB icon_06_04"></span><strong>탐지 시간</strong></h4>
					<div class="items"> <!-- item contnets // --><span class="imgWrap"><canvas id="lineChart" width="1396" height="280"></canvas></span><!-- // item contnets --> </div>
				</div>
			</div>
		</div>
		<div class="grid-row">
			<div class="item-box col-12">
				<div class="inner">
					<h4 class="item-title"><span class="iconWrapB icon_search"></span><strong>조회조건</strong></h4>
					<div class="items" style="overflow: visible"> 
						<!-- item contnets // -->
						<div class="schwrap">
							<ul>
								<li>
									<label>시간
									<input id="frDt" type="datetime-local" data-placeholder="날짜 선택" value="" class="form-control"></input>
									   ~
									<input id="toDt" type="datetime-local" data-placeholder="날짜 선택" value="" class="form-control"></input>
									<!-- 	<input type="text" class="form-control" placeholder="2023-01-01 10:00"> 
										~
										<input type="text" class="form-control" placeholder="2023-01-01 10:00">-->
									</label>
									<label>송신 IP
										<input id="schSrcIp" type="text" class="form-control" placeholder="192.168.100.102">
									</label>
								</li>
								<li>
								     <div  class="selectWrap">탐지방식
									    <div class="multiselect">
											<div class="selectBox">
												<div class="selected">
													<div class="selected-value">전체</div>
													<div class="arrow"></div>
												</div>
												<div class="overSelect"></div>
											</div>
											<div id="schThreatDetectionMethod" class="checkboxes" style="display:none;">
												
											</div>
										</div> 
									</div>
									<label>수신 IP
										<input id="schDstIp" type="text" class="form-control" placeholder="192.168.100.102">
									</label>
								</li>
								<li>
									<div  class="selectWrap">정오탐 판정
									    <div class="multiselect">
											<div class="selectBox">
												<div class="selected">
													<div class="selected-value">전체</div>
													<div class="arrow"></div>
												</div>
												<div class="overSelect"></div>
											</div>
											<div id="schAnalysisResult" class="checkboxes" style="display:none;">
												
											</div>
										</div> 
									</div>
									<label>송신 IP Port
										<input type="text" id="schSrcPort" class="form-control number" maxlength="5" placeholder="8500">
									</label>
								</li>
								<li>
									<div  class="selectWrap">위협 중요도
									    <div class="multiselect">
											<div class="selectBox">
												<div class="selected">
													<div class="selected-value">전체</div>
													<div class="arrow"></div>
												</div>
												<div class="overSelect"></div>
											</div>
											<div id="schThreatImportance" class="checkboxes" style="display:none;">
												
											</div>
										</div> 
									</div>
									<label>수신 IP Port
										<input type="text" id="schDstPort" class="form-control number" maxlength="5" placeholder="6500">
									</label>
								</li>
							</ul>
							<div>
							<button class="btn medium darkblue initBtn"><span class="iconBtn icon_reset"></span><strong>초기화</strong></button>
							<button class="btn medium darkblue schBtn"><span class="iconBtn icon_btn_01"></span><strong>검색</strong></button>
							</div>
						</div>
						<!-- // item contnets --> 
					</div>
				</div>
			</div>
		</div>
		<div class="grid-row">
			<div class="item-box col-12">
				<div class="inner">
					<h4 class="item-title"><span class="iconWrapB icon_list"></span>
					<strong>조회목록</strong>
					<a class="btn small darkblue totCnt" style="float:right;display:none;"><span class="iconBtn icon_btn_01"></span><strong id="cntVal"></strong></a>
					</h4>
					
					<div class="items" style="height:380px; overflow:hidden"> 
						<div class="tablewrap">
							<table>
								<thead class="tHead">
								</thead>
								<tbody class="tBody">
								</tbody>
							</table>
						</div>
						<div class="page_wrap">
							<div class="page_nation">
								<input type="hidden" name="rowPerPage" class="rowPerPage" value="6">
							</div>							
						</div>
					</div>
				</div>
			</div>
		</div>
		<!--//Grid--> 
	</div>
</div>

 <div class="dim-layer">
	<div class="dimBg"></div>
	<div id="threatList" class="pop-layer xxxlarge">
		<!--Title-->
		<div class="Popup-title">
			<h3><strong>위협 목록</strong></h3>
			<button class="icon-close">닫기</button>
		</div>
		<div class="Popup-container">
			<!--Contens-->
			<div class="Popup-contents">
				<div class="tablewrap" style="height:690px; overflow:auto;">
					<table >
						<thead class="tHead">
						</thead>
						<tbody class="tBody" >
						</tbody>
					</table>
				</div>
			    <input type="hidden" name="pageNo" class="pageNo" value="1">
				<input type="hidden" name="rowPerPage" class="rowPerPage" value="15">
			</div>
		</div>
		<div class="Popup-footer">
		<div class="btnWrap">
		<div class="left"></div>
		<div class="right">
		    <a class="btn medium darkblue btnMore"><span class="iconBtn icon_btn_02"></span><strong>더 보기</strong></a>
			<a href="javascript:;" class="btn medium darkblue popClose"><span class="iconBtn icon_btn_08"></span><strong>닫기</strong></a>
		</div>
		</div>
		</div>
	</div>
</div>
<!--정오탐 판정 modal popup//-->
<div class="dim-layer">
	<div class="dimBg"></div>
	<div id="tfpositive" class="pop-layer large">
		<!--Title-->
		<div class="Popup-title">
			<h3><span class="iconWrapB icon_08_01"></span><strong>정오탐판정</strong></h3>
			<button class="icon-close">닫기</button>
		</div>
		<div class="Popup-container">
			<!--Contens-->
			<div class="Popup-contents">
				<div class="assetWrap tfpositive">
					<ul class="clfix">
					    <li>
							<label>
								<span th:if="${!(activeProfile.equals('hmmLand') || activeProfile.equals('hmmNavy') || activeProfile.equals('lnsystem-hmm-land') || activeProfile.equals('lnsystem-hmm-navy'))}">부대명</span>
								<span th:if="${activeProfile.equals('hmmLand') || activeProfile.equals('hmmNavy') || activeProfile.equals('lnsystem-hmm-land') || activeProfile.equals('lnsystem-hmm-navy')}">회사명</span>
								<input type="text" id="unitId" class="form-control" readonly>
								<input type="hidden" id="threatId">
								<input type="hidden" id="analysisId">
							</label>
						</li>
						<li>
							<label>
								<span th:if="${!(activeProfile.equals('hmmLand') || activeProfile.equals('hmmNavy') || activeProfile.equals('lnsystem-hmm-land') || activeProfile.equals('lnsystem-hmm-navy'))}">함명</span>
								<span th:if="${activeProfile.equals('hmmLand') || activeProfile.equals('hmmNavy') || activeProfile.equals('lnsystem-hmm-land') || activeProfile.equals('lnsystem-hmm-navy')}">선박명</span>
								<input type="text" id="shipId" class="form-control" readonly>
							</label>
						</li>
						<li>
							<label>
								<span>탐지시간</span>
								<input type="text" id="detectionTime" class="form-control" readonly>
							</label>
						</li>
						<li>
							<label>
								<span>송신IP</span>
								<input type="text" id="srcIp" class="form-control" readonly>
							</label>
						</li>
						<li>
						    <label>
								<span>송신Port</span>
								<input type="text" id="srcPort" class="form-control" readonly>
							</label>
						</li>
						<li>
							<label>
								<span>수신IP</span>
								<input type="text" id="dstIp" class="form-control" readonly>
							</label>
						</li>
						<li>
						    <label>
								<span>수신Port</span>
								<input type="text" id="dstPort" class="form-control" readonly>
							</label>
						</li>
						<li>
						    <label>
								<span>전송 프로토콜</span>
								<input type="text" id="protocol" class="form-control" readonly>
							</label>
						</li>
						<li>
						    <label>
								<span>페이로드 크기</span>
								<input type="text" id="payloadSize" class="form-control" readonly>
							</label>
						</li>
						<li>
						    <label>
								<span>파편화 유무</span>
								<input type="text" id="fragmentation" class="form-control" readonly>
							</label>
						</li>
						<li>
						    <label>
								<span>파편화 ID</span>
								<input type="text" id="fragmentId" class="form-control" readonly>
							</label>
						</li>
						<li>
						    <label>
								<span>탐지 위협명</span>
								<input type="text" id="detectionThreatName" class="form-control" readonly>
							</label>
						</li>
						<li>
						    <label>
								<span>탐지방식</span>
								<input type="text" id="threatDetectionMethod" class="form-control" readonly>
							</label>
						</li>
						<li>
						    <label>
								<span>위협 중요도</span>
								<input type="text" id="threatImportance" class="form-control" readonly>
							</label>
						</li>
						<li th:if="${auth.equals('2') || auth.equals('3')}">
						    <div>정오탐 판정
						        <div  class="select" style="padding-left: 35px">
									<div class="selected">
										<div data-value='' class="selected-value">선택</div>
										<div class="arrow"></div>
									</div>
									<ul id="analysisResult">
									</ul>
								</div>
							</div>
						</li>
						<li th:if="${!auth.equals('2') && !auth.equals('3')}">
						    <label>
								<span>정오탐 판정</span>
								<input type="text" id="analysisResult" class="form-control" readonly>
							</label>
						</li>
						<li th:if="${auth.equals('2') || auth.equals('3')}">
						    <div>조치결과
						        <div class="select" style="padding-left: 35px">
									<div class="selected">
										<div data-value='' class="selected-value">선택</div>
										<div class="arrow"></div>
									</div>
									<ul id="actionResult">
									</ul>
								</div>
							</div>
						</li>
						<li th:if="${!auth.equals('2') && !auth.equals('3')}">
						    <label>
								<span>조치결과</span>
								<input type="text" id="actionResult" class="form-control" readonly>
							</label>
						</li>
						<li style="float: nont; width: 100%; display: block">
						    <label>
								<span>페이로드</span>
							    <textarea id="payloadContent" cols="10" rows="10" readonly="readonly"></textarea>
							</label>
						</li>
					</ul>
				</div>
			</div>
		</div>
		<div class="Popup-footer">
			<a th:if="${auth.equals('2') || auth.equals('3')}" href="javascript:;" class="btn medium darkblue saveBtn"><span class="iconBtn icon_btn_09"></span><strong>확인</strong></a>
			<a href="javascript:;" class="btn medium darkblue popClose"><span class="iconBtn icon_btn_08"></span><strong>취소</strong></a>
		</div>
	</div>
</div>
<!--//modal popup-->



<script th:inline="javascript"> 
	window.addEventListener('DOMContentLoaded', () => {
		ncos.schMode = 'auto';
		init();
		initWhiteList();
		ncos.intervalFunc = setInterval(searchFunc, ncos.interval);//50초
		document.querySelector('.initBtn').addEventListener('click',e => {
			e.preventDefault();
			ncos.schMode = 'auto';
			ncos.initBtn = true;
			gfn_initObj(document.querySelector('.schwrap'));
			searchFunc();
			ncos.intervalFunc = setInterval(searchFunc, ncos.interval);//50초
	    });	    
	    document.querySelector('.schBtn').addEventListener('click',e => {
	    	e.preventDefault();
	    	ncos.schMode = 'menual';
	    	clearInterval(ncos.intervalFunc);
	    	searchFunc(e.target);
	    });
	});

	let lineChart = null;
    const init = () => {
    	document.getElementById('frDt').value= gfn_getDiffDt(ncos.diffDay);
    	document.getElementById('toDt').value= gfn_getTodayDt();
    	createMultiChk(document.getElementById('schThreatDetectionMethod'),'THTY');
    	createMultiChk(document.getElementById('schAnalysisResult'),'THRES');
    	createMultiChk(document.getElementById('schThreatImportance'),'THIM');
    	let headColumns =null;
    	if(activeProfile === 'navy' || activeProfile === 'lnsystemNavy' || activeProfile === 'hmmNavy' || activeProfile === 'lnsystemHmmNavy'){
    		 headColumns = [{data_id:"id",label:"id",width:"0px"}
		        ,{data_id:"detectionTime",label:"탐지시간" ,data_dateFrmt:"yy-mm-dd hh:mi:ss"}
		        ,{data_id:"srcIp",label:"송신IP"}
		        ,{data_id:"dstIp",label:"수신IP"}
		        ,{data_id:"srcPort",label:"송신Port"}
		        ,{data_id:"dstPort",label:"수신Port"}
		        ,{data_id:"threatDetectionMethod",label:"탐지방식", data_grpCd:"THTY"}
		        ,{data_id:"detectionThreatName",label:"탐지 위험명"}
		        ,{data_id:"analysisResult",label:"정오탐판정",data_grpCd:"THRES"}
		        ,{data_id:"threatImportance",label: "위협중요도",data_grpCd:"THIM", data_class:"threat"}
		        ,{data_id:"detailBtn",label: "상세보기", data_btnNm:"상세보기"}
		       ];
    	}
    	else{
    		 headColumns = [{data_id:"id",label:"id",width:"0px"}
		        ,{data_id:"detectionTime",label:"탐지시간" ,data_dateFrmt:"yy-mm-dd hh:mi:ss"}
		        ,{data_id:"shipId",width:"0px"}
		        ,{data_id:"shipNm",label:"함명",data_grpCd:"COSH"} 
		        ,{data_id:"srcIp",label:"송신IP"}
		        ,{data_id:"dstIp",label:"수신IP"}
		        ,{data_id:"srcPort",label:"송신Port"}
		        ,{data_id:"dstPort",label:"수신Port"}
		        ,{data_id:"threatDetectionMethod",label:"탐지방식", data_grpCd:"THTY"}
		        ,{data_id:"detectionThreatName",label:"탐지 위험명"}
		        ,{data_id:"analysisResult",label:"정오탐판정",data_grpCd:"THRES"}
		        ,{data_id:"threatImportance",label: "위협중요도",data_grpCd:"THIM", data_class:"threat"}
		        ,{data_id:"detailBtn",label: "상세보기", data_btnNm:"상세보기"}
		       ];
    	}
       
		gridInit(document.querySelector('.tablewrap'),headColumns);
		pageInit(document.querySelector(".page_nation"),searchFunc,page.rowPerPage);
		searchFunc();
    }
    const searchFunc = (invoker) => {
    	pageSearch("/getThreatList",document.querySelector(".tablewrap"),document.querySelector(".page_nation"),invoker,searchFunc,searchAfterFunc);
    	
    }
    
    const searchAfterFunc = (appendData) => {
    	
    	if(ncos.schMode == 'menual'){
    		document.querySelector('.totCnt').style.display = '';
    		if(appendData.totCount > 0){
        		document.querySelector('.totCnt').setAttribute("href","javascript:searchThreatAllList();");
        	}
        	else{
        		document.querySelector('.totCnt').removeAttribute("href");
        	}
        	document.querySelector('#cntVal').textContent = '건수 : '+appendData.totCount+'';
    	}
    	else{
    		setStatus(appendData.eventStatusInfo);
        	drawLineChart(appendData.detectPriorList);
    		document.querySelector('.totCnt').style.display = 'none';
    	}
    	
    }
    
    const detailFunc = (data) => {
    	setThreatAnalysis(data);
    }
    
    const trncThreatAnalysisAfterFunc = () => {
    	settingThreatAnalysis.querySelector('.popClose').click();
    	searchFunc();
    }
   
    
    const setStatus = (data) => {
    	//console.log("setStatus data:",data);
    	let eventRating = document.querySelector('.eventRating');
    	let eventLis = eventRating.querySelectorAll('li');
    	eventLis.forEach((li,index) => {
    		let strong = li.querySelector('strong');
    		strong.innerHTML = '';
    		if(li.classList.contains('high')){
    			strong.append(data.highPrior);
    		}
    		else if(li.classList.contains('middle')){
    			strong.append(data.middlePrior);
    		}
            else if(li.classList.contains('low')){
            	strong.append(data.lowPrior);
    		}
    	});
    	
    	let eventNum = document.querySelector('.eventNum');
    	let eventStrong = eventNum.querySelector('strong');
    	let eventSpan = eventNum.querySelector('span');
    	eventStrong.innerHTML = '';
    	eventSpan.innerHTML = '';
    	eventStrong.append(data.detectEventCnt);  //(↓15)
    	if(data.updownCnt > 0) {
    		eventSpan.append('(↑'+data.updownCnt+')');
    	}
    	else if(data.updownCnt === 0) {
    		eventSpan.append('('+data.updownCnt+')');
    	}
    	else{
    		eventSpan.append('(↓'+data.updownCnt*(-1)+')');
    	}
    }
    
    const drawLineChart = (chartData) => {
    	//console.log("drawLineChart1 chartData:",chartData);
    	let lineLabels = new Array();
    	let dataH = new Array();
    	let dataM = new Array();
    	let dataL = new Array();
    	chartData.forEach((chartItem,index) => {
    		if(chartItem.threat === 'H'){
    			lineLabels.push(chartItem.hm);
    			dataH.push(chartItem.cnt);
    	    }
    		else if(chartItem.threat === 'M'){
    			dataM.push(chartItem.cnt);
    		}
            else if(chartItem.threat === 'L'){
            	dataL.push(chartItem.cnt);
    		}
    	});
    	

    	const lineData = {labels: lineLabels,
    			          datasets: [{ label: ' 상',
    			                        data: dataH,
    			                        fill: false,
    			                        pointStyle: 'circle',
    			                        pointRadius: 4,
    			                        borderColor: 'rgb(255, 0, 0)',
    			                        backgroundColor: 'rgb(255, 0, 0)',
    			                        tension: 0.1
    			                    },
    			                    { label: ' 중',
    			                        data: dataM,
    			                        fill: false,
    			                        pointStyle: 'circle',
    			                        pointRadius: 4,
    			                        borderColor: 'rgb(255, 165, 0)',
    			                        backgroundColor: 'rgb(255, 165, 0)',
    			                        tension: 0.1
    			                    },
    			                    { label: ' 하',
    			                        data: dataL,
    			                        fill: false,
    			                        pointStyle: 'circle',
    			                        pointRadius: 4,
    			                        borderColor: 'rgb(255, 254, 2)',
    			                        backgroundColor: 'rgb(255, 254, 2)',
    			                        //pointBorderColor: 'rgb(75, 89, 192)',
    			                        tension: 0.1
    			                    }
    			                    ]
    	                 };
    	
    	const config = { type: 'line',
    			         data: lineData,
    			         options: { responsive: true,
		    			        	animation: {
					        	         duration: 0
					        	    },
    			        	        scales: {
    			        	                 x: {
    			        	                	 ticks: {
    			        	                         color: 'black',
    			        	                	 },
    			        	                	
    			        	                 },
    			        	                 y: {
    			        	                	 ticks: {
    			        	                         color: 'black',
    			        	                     },
    			        	                     grid: {
    			        	                    	 color : 'rgb(90, 90, 90)',
    			        	                         display: true,
    			        	                         //drawOnChartArea: true,
    			        	                         //drawTicks: true,
    			        	                     }
    			        	                 }
    			        	             },
    			        	             
	    			        	    plugins: {legend: {
	    	       			    		      position: 'bottom',
	    	       			                  display: true,
	    	       			                  labels: {
	    	       			                	  usePointStyle: true,
	    	       			                	  color: 'black',
	    	       			                	  padding : 30,
	    	       			                      font: {
	                                                size: 15,
	    	       		                          }
	    	       			                	// fill : true
	    	       			                  }
	    	       			           }
	    	       			      }
    			         },
    			        };
    	let uiMode = gfn_getStorage(ncos.uiMode);
       	config.options.scales.x.ticks.color = chartColor;
       	config.options.scales.y.ticks.color = chartColor;
       	config.options.plugins.legend.labels.color = chartColor;
    
    	if(lineChart != null){
    		lineChart.destroy();
	    }
    	lineChart = new Chart(document.getElementById('lineChart').getContext("2d"),config);	 
    	
    }
    
    const searchThreatAllList = () => {
    	const headColumns = [{data_id:"id",label:"id",width:"0px"}
					        ,{data_id:"detectionTime",label:"탐지시간" ,data_dateFrmt:"yy-mm-dd hh:mi:ss"}
					        ,{data_id:"srcIp",label:"송신IP"}
					        ,{data_id:"dstIp",label:"수신IP"}
					        ,{data_id:"srcPort",label:"송신Port"}
					        ,{data_id:"dstPort",label:"수신Port"}
					        ,{data_id:"threatDetectionMethod",label:"탐지방식", data_grpCd:"THTY"}
					        ,{data_id:"detectionThreatName",label:"탐지 위험명"}
					        ,{data_id:"analysisResult",label:"정오탐판정",data_grpCd:"THRES"}
					        ,{data_id:"threatImportance",label: "위협중요도",data_grpCd:"THIM", data_class:"threat"}
					        ,{data_id:"detailBtn",label: "상세보기", data_btnNm:"상세보기"}
					       ];
     
   		gridInit(document.querySelector('#threatList').querySelector('.tablewrap'),headColumns);
   		document.querySelector('#threatList').querySelector('.pageNo').setAttribute("value",1);
   		document.querySelector('#threatList').querySelector('.btnMore').setAttribute("href","javascript:searchThreatMore();");
   		let param = { "pageNo" : document.querySelector('#threatList').querySelector('.pageNo').getAttribute("value")
	                , "rowPerPage" : Number(document.querySelector('#threatList').querySelector('.rowPerPage').getAttribute("value"))
    		        };
    	gfn_schParam(param);
	 	gfn_asyncJsonCall('/getThreatAllList','POST',param).then((data) => {
	 		let list = data['list'];
	 		gridBind(list,document.querySelector('#threatList').querySelector('.tablewrap'));
	 		return list;
	 	}).then((data) => {
            if(data.length < 15){
            	document.querySelector('#threatList').querySelector('.btnMore').removeAttribute("href");
	 		}
	 		layerPopup('#threatList');
	 	});

    }
    
    const searchThreatMore = () => {
    	let pageNo = Number(document.querySelector('#threatList').querySelector('.pageNo').getAttribute("value"));
    	pageNo++;
    	let param = { pageNo
                    , "rowPerPage" : Number(document.querySelector('#threatList').querySelector('.rowPerPage').getAttribute("value"))
			        };
		gfn_schParam(param);
	 	gfn_asyncJsonCall('/getThreatAllList','POST',param).then((data) => {
	 		let list = data['list'];
	 		gridBind(list,document.querySelector('#threatList').querySelector('.tablewrap'),'Y');
	 		return list;
	 	}).then((data) => {
	 		if(data.length < 15){
	 			document.querySelector('#threatList').querySelector('.btnMore').removeAttribute("href");
	 		}
	 		document.querySelector('#threatList').querySelector('.pageNo').setAttribute("value",pageNo);
	 	});
    }
  
</script>
</th:block>
</html>
