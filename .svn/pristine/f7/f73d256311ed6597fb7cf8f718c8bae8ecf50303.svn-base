<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="Func">
  
  <select id="selectFuncCount" parameterType="map" resultType="long">
        SELECT COUNT(1) 
          FROM func_operation_state A
        <include refid="whereFuncList"></include>
  </select>

  <select id="selectFuncList" parameterType="HashMap" resultType="CmmnMap">

     	SELECT  RN
     	      , B.OP_STATUS_ID ID
     	      , B.COLLECTION_TIME 
     	      , B.CSC_NAME
     	      , B.REASON
     	      , B.STATUS
        FROM ( SELECT A.OP_STATUS_ID
                    , ROW_NUMBER() OVER (ORDER BY A.OP_STATUS_ID DESC) AS RN
               FROM func_operation_state A
               <include refid="whereFuncList"></include>
               LIMIT #{startRow},#{rowPerPage}) A
        STRAIGHT_JOIN func_operation_state B
        ON (A.OP_STATUS_ID = B.OP_STATUS_ID)
        ORDER BY RN

  </select>
  
   <sql id="whereFuncList">
         <where>
	         <choose>
	         <when test='schMode != null and schMode.equals("menual")'>
		         <if test='frDt != null and !frDt.equals("")'>
		         AND A.COLLECTION_TIME <![CDATA[>=]]> #{frDt}
		         </if>
		         <if test='toDt != null and !toDt.equals("")'>
		         AND A.COLLECTION_TIME <![CDATA[<=]]> #{toDt}
		         </if>
	             <if test='schCscName != null'>
                 AND A.CSC_NAME IN 
                 <foreach collection="schCscName" item="item" open="(" close=")" separator="," index="idx">
		            #{item}
			     </foreach> 
                 </if>
                 <if test='schStatus != null and !schStatus.equals("")'>
		         AND A.STATUS = #{schStatus}
		         </if>
		          <if test='schReason != null and !schReason.equals("")'>
		         AND A.REASON LIKE CONCAT('%', #{schReason},'%')
		         </if>
	         </when>
	         <otherwise>
	         AND A.COLLECTION_TIME > DATE_ADD(NOW(), INTERVAL -#{intervalHm} HOUR)
	         </otherwise>
	         </choose>
         </where>
   </sql>
  
  
  <select id="selectCscStatus" parameterType="map" resultType="CmmnMap">

     	SELECT CSC_ID
     	     , CAST(STATUS as VARCHAR(1)) STATUS
         FROM csc_status
         ORDER BY CSC_ID

  </select>
  
  <select id="selectShipStatusList" parameterType="HashMap" resultType="CmmnMap">

     	SELECT SHIP_ID, UNIT_ID,DETECTION_TIME,SHIP_STATUS_ID
          FROM ship_status
          ORDER BY SHIP_ID
  </select>
  
 
   
</mapper>