<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="Log">

  <select id="selectUserAuditCount" parameterType="map" resultType="long">
        SELECT COUNT(1)
          FROM user_action A
          LEFT JOIN user_account B
          ON A.ACCOUNT_ID = B.ACCOUNT_ID
          <include refid="whereUserAuditList"></include>
  </select>

  <select id="selectUserAuditList" parameterType="map" resultType="CmmnMap">

     	SELECT  RN
     	      , B.ACTION_ID ID
     	      , B.COLLECTION_TIME
     	      , A.USERNAME
     	      , B.WORK_CODE_ID
     	      , B.WORK_UI_ID
     	      , B.WORK_CONTENT
     	      , B.RESULT

        FROM ( SELECT A.ACTION_ID
                    , B.USERNAME
                    , ROW_NUMBER() OVER (ORDER BY A.COLLECTION_TIME DESC) AS RN
               FROM user_action A
               LEFT JOIN user_account B
               ON A.ACCOUNT_ID = B.ACCOUNT_ID
               <include refid="whereUserAuditList"></include>
               LIMIT #{startRow},#{rowPerPage}) A
        STRAIGHT_JOIN user_action B
        ON (A.ACTION_ID = B.ACTION_ID)
        ORDER BY RN

  </select>

  <sql id="whereUserAuditList">
         <where>
	         <choose>
	         <when test='schMode != null and schMode.equals("menual")'>
	         <if test='frDt != null and !frDt.equals("")'>
	         AND A.COLLECTION_TIME <![CDATA[>=]]> #{frDt}
	         </if>
	         <if test='toDt != null and !toDt.equals("")'>
	         AND A.COLLECTION_TIME <![CDATA[<=]]> #{toDt}
	         </if>
	         <if test='schUserId != null'>
              AND B.ACCOUNT_ID IN
              <foreach collection="schUserId" item="item" open="(" close=")" separator="," index="idx">
	            #{item}
		      </foreach>
              </if>
              <if test='schCls != null'>
              AND A.WORK_UI_ID IN
              <foreach collection="schCls" item="item" open="(" close=")" separator="," index="idx">
	            #{item}
		      </foreach>
              </if>
              <if test='schActTp != null'>
              AND A.WORK_CODE_ID IN
              <foreach collection="schActTp" item="item" open="(" close=")" separator="," index="idx">
	            #{item}
		     </foreach>
              </if>
              <if test='schActResult != null'>
              AND A.RESULT IN
              <foreach collection="schActResult" item="item" open="(" close=")" separator="," index="idx">
	            #{item}
		      </foreach>
              </if>
	         </when>
	         <otherwise>
	         AND A.COLLECTION_TIME > DATE_ADD(NOW(), INTERVAL -#{intervalHm} HOUR)
	         </otherwise>
	         </choose>
         </where>
  </sql>


  <update id="insertUserAction" parameterType="LogVo" useGeneratedKeys="true" keyProperty="actionId">
        INSERT INTO user_action(ACCOUNT_ID
                              , COLLECTION_TIME
                              , WORK_UI_ID
                              , WORK_CODE_ID
                              , WORK_CONTENT
                              , RESULT)
				        VALUES( #{accountId}
				              , SYSDATE()
				              , #{workUiId}
				              , #{workCodeId}
				              , #{workContent}
				              , #{result})
  </update>
  <update id="insertUserActionNcos" parameterType="LogVo">
        INSERT INTO user_action(ACCOUNT_ID
                              , COLLECTION_TIME
                              , WORK_UI_ID
                              , WORK_CODE_ID
                              , WORK_CONTENT
                              , RESULT
                              , INTEGRITY)
				        VALUES( #{accountId}
				              , STR_TO_DATE(#{collectionTime}, '%Y-%m-%d %H:%i.%s')
				              , #{workUiId}
				              , #{workCodeId}
				              , #{workContent}
				              , #{result}
				              , #{integrity})
  </update>

  <update id="updateUserActionNcos" parameterType="LogVo">
        UPDATE user_action SET INTEGRITY = #{integrity}
        WHERE  ACTION_ID = #{actionId}
  </update>
</mapper>